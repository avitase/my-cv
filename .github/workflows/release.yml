name: Build CV formats and attach to GitHub Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-fonts-recommended

      - name: Build all CV formats
        run: |
          make
          ls -lah build

      - name: Create release and upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"

          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" \
              --title "$TAG" \
              --notes "Automated build of the CV in multiple formats (MD, PDF, DOCX, HTML, TXT)."
          fi

          gh release upload "$TAG" build/* --clobber

